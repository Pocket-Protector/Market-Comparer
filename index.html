<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>DEX Market Viewer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --bg:#0f172a; --panel:#0e1729; --border:#1f2937; --text:#e5e7eb; --muted:#94a3b8; }
  body { margin:0; background:#0b1020; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  .container { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 10px 0; }
  .legend { display:flex; gap:10px; align-items:center; font-size:12px; color:var(--muted); margin-bottom:10px; }
  .chip { padding:4px 8px; border-radius: 999px; border:1px solid var(--border); background:#121a30; }
  .chip.drift { background:#f3e8ff22; } .chip.dydx { background:#dbeafe22; } .chip.hyper { background:#bbf7d022; }

  .toolbar { display:flex; flex-wrap:wrap; gap:12px; align-items:center; background:var(--panel); border:1px solid var(--border); padding:12px; border-radius:12px; }
  .toolbar label { font-size:12px; color: var(--muted); }
  .toolbar input[type="text"], .toolbar select { padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#0b1325; color:var(--text); }

  .table-wrap { margin-top:16px; background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  table { width:100%; border-collapse:separate; border-spacing:0; }
  thead th { position: sticky; top: 0; background:#0b1325; color:#cbd5e1; font-weight:600; font-size:12px;
             text-align:left; padding:10px; border-bottom:1px solid var(--border); user-select:none; }
  thead th.sortable { cursor:pointer; }
  thead th.sortable .arrow { opacity:0.5; margin-left:6px; font-size:11px; }
  thead th.sortable.active .arrow { opacity:1; }
  tbody td { padding:10px; font-size:13px; border-bottom:1px solid #111827; }
  .group-row td { background:#0b1020; color:#93c5fd; font-weight:700; font-size:12px; text-transform: uppercase;
                  letter-spacing:0.06em; border-top:1px solid var(--border); }

  .ex-drift td { background:#8d23ff22; } .ex-drift:hover td { background:#f3e8ff33; }
  .ex-dydx td { background:#2382ff22; } .ex-dydx:hover td { background:#dbeafe33; }
  .ex-hyperliquid td { background:#25ff7122; } .ex-hyperliquid:hover td { background:#bbf7d033; }

  .badge { font-size:11px; padding:2px 6px; border-radius:6px; border:1px solid #233047; color:#a5b4fc; background:#0b1325; }
  .empty { color:#64748b; font-style:italic; }
  .footer { margin-top:10px; font-size:12px; color:#94a3b8; }
</style>
</head>
<body>
  <div class="container">
    <h1>DEX Market Viewer</h1>
    <div class="legend">
      <span class="chip drift">drift</span>
      <span class="chip dydx">dydx</span>
      <span class="chip hyper">hyperliquid</span>
    </div>
    <div class="toolbar">
      <label>Symbol filter: <input id="symFilter" type="text" placeholder="e.g. BTC-USD" /></label>
      <label>Type:
        <select id="typeFilter">
          <option value="">All</option>
          <option value="CROSS">CROSS</option>
          <option value="ISOLATED">ISOLATED</option>
        </select>
      </label>
    </div>

    <div class="table-wrap">
      <table id="grid">
        <thead>
          <tr>
            <th style="width:14%">Exchange</th>
            <th style="width:12%">Type</th>
            <th style="width:18%">Symbol</th>
            <th class="sortable" data-key="leverage_max" style="width:12%">Leverage <span class="arrow">↕</span></th>
            <th style="width:14%">Price (USD)</th>
            <th class="sortable" data-key="volume_24h_usd" style="width:15%">24h Vol (USD) <span class="arrow">↕</span></th>
            <th class="sortable" data-key="open_interest_usd" style="width:15%">OI (USD) <span class="arrow">↕</span></th>
          </tr>
        </thead>
        <tbody id="body">
          <tr><td colspan="7" class="empty">Loading all_latest.csv…</td></tr>
        </tbody>
      </table>
    </div>
    <div class="footer" id="summary"></div>
  </div>

<script>
/* ====== STATE ====== */
const tbody   = document.getElementById('body');
const summary = document.getElementById('summary');
const symFilterEl  = document.getElementById('symFilter');
const typeFilterEl = document.getElementById('typeFilter');
const headerCells  = Array.from(document.querySelectorAll('thead th.sortable'));

let rowsRaw = [];      // parsed CSV rows
let rowsFiltered = []; // after filters
let sortKey = null;    // 'leverage_max' | 'volume_24h_usd' | 'open_interest_usd'
let sortDir = 'desc';  // 'asc' | 'desc'

/* ====== UTILS ====== */
const num = (v) => { if (v === null || v === undefined || v === '') return null; const n = Number(v); return Number.isFinite(n) ? n : null; };
const fmt = (v, digits=2) => { const n = num(v); return n === null ? '' : n.toLocaleString(undefined, { maximumFractionDigits: digits }); };
const exClass = (ex) => { const s = String(ex||'').toLowerCase(); if (s.includes('drift')) return 'ex-drift'; if (s.includes('dydx')) return 'ex-dydx'; if (s.includes('hyper')) return 'ex-hyperliquid'; return ''; };

function ensureColumns(row) {
  const m = {}; for (const k in row) m[k.toLowerCase()] = row[k];
  return {
    exchange: m['exchange'] ?? '',
    market_type: (m['market_type'] ?? '').toUpperCase(),
    symbol_raw: (m['symbol_raw'] ?? '').toUpperCase(),
    leverage_max: m['leverage_max'] ?? '',
    price_usd: m['price_usd'] ?? '',
    volume_24h_usd: m['volume_24h_usd'] ?? '',
    open_interest_usd: m['open_interest_usd'] ?? '',
  };
}

/* ====== GROUP-LEVEL SORT HELPERS ======
   We rank each symbol group by the *max* value of the active sortKey.
   This moves whole groups up/down when sorting. */
function groupMaxValue(group, key) {
  let top = null;
  for (const r of group) {
    const v = num(r[key]);
    if (v !== null) top = (top === null ? v : Math.max(top, v));
  }
  return top; // can be null if all missing
}

/* ====== RENDER ====== */
function renderTable(data) {
  if (!data || data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="empty">No rows match the current filters.</td></tr>`;
    summary.textContent = '';
    return;
  }

  // group by symbol
  const groups = {};
  for (const r of data) {
    const sym = (r.symbol_raw || '').toUpperCase();
    (groups[sym] ??= []).push(r);
  }

  // ORDER GROUPS:
  // - if sortKey is set: order by group max of that metric (desc/asc)
  // - else: alphabetical by symbol
  let symbols = Object.keys(groups);
  if (sortKey) {
    const dir = (sortDir === 'asc') ? 1 : -1;
    symbols.sort((a, b) => {
      const av = groupMaxValue(groups[a], sortKey);
      const bv = groupMaxValue(groups[b], sortKey);
      if (av === null && bv === null) return a.localeCompare(b);
      if (av === null) return 1;   // nulls last
      if (bv === null) return -1;
      return (av < bv ? -1 : av > bv ? 1 : 0) * dir;
    });
  } else {
    symbols.sort((a,b) => a.localeCompare(b));
  }

  // BUILD HTML
  let html = ''; let total = 0;
  for (const sym of symbols) {
    let group = groups[sym];

    // order rows in each group by sortKey (if any), else by exchange
    if (sortKey) {
      const dir = (sortDir === 'asc') ? 1 : -1;
      group = group.slice().sort((a,b) => {
        const av = num(a[sortKey]); const bv = num(b[sortKey]);
        if (av === null && bv === null) return String(a.exchange).localeCompare(String(b.exchange));
        if (av === null) return 1;
        if (bv === null) return -1;
        return (av < bv ? -1 : av > bv ? 1 : 0) * dir;
      });
    } else {
      group = group.slice().sort((a,b) => String(a.exchange).localeCompare(String(b.exchange)));
    }

    html += `<tr class="group-row"><td colspan="7">${sym}</td></tr>`;
    for (const r of group) {
      html += `
        <tr class="${exClass(r.exchange)}">
          <td>${r.exchange ?? ''}</td>
          <td><span class="badge">${r.market_type ?? ''}</span></td>
          <td>${r.symbol_raw ?? ''}</td>
          <td>${r.leverage_max !== '' && r.leverage_max != null ? `${r.leverage_max}x` : ''}</td>
          <td>${fmt(r.price_usd, 6)}</td>
          <td>${fmt(r.volume_24h_usd, 2)}</td>
          <td>${fmt(r.open_interest_usd, 2)}</td>
        </tr>`;
      total++;
    }
  }

  tbody.innerHTML = html;
  summary.textContent = `Showing ${total} rows across ${symbols.length} symbols.`;
}

/* ====== FILTERS & SORT ====== */
function applyFilters() {
  const q = String(symFilterEl.value || '').trim().toUpperCase();
  const t = String(typeFilterEl.value || '').toUpperCase();

  rowsFiltered = rowsRaw.filter(r => {
    if (q && !String(r.symbol_raw || '').toUpperCase().includes(q)) return false;
    if (t && String(r.market_type || '').toUpperCase() !== t) return false;
    return true;
  });

  renderTable(rowsFiltered);
}

function setSort(newKey) {
  if (sortKey === newKey) {
    sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
  } else {
    sortKey = newKey;
    sortDir = 'desc';
  }
  headerCells.forEach(th => {
    th.classList.toggle('active', th.dataset.key === sortKey);
    const arrow = th.querySelector('.arrow');
    if (arrow) arrow.textContent = (th.dataset.key === sortKey)
      ? (sortDir === 'asc' ? '↑' : '↓') : '↕';
  });
  renderTable(rowsFiltered);
}

/* ====== LOAD CSV (auto) ====== */
function fetchCSV() {
  fetch('data/latest/all_latest.csv', { cache: 'no-store' })
    .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.text(); })
    .then(text => {
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      rowsRaw = (parsed.data || []).map(ensureColumns);
      applyFilters();
    })
    .catch(err => {
      tbody.innerHTML = `<tr><td colspan="7" class="empty">Failed to load all_latest.csv (${String(err)}). Ensure it's in the repo root.</td></tr>`;
    });
}

/* ====== EVENTS ====== */
symFilterEl.addEventListener('input', applyFilters);
typeFilterEl.addEventListener('change', applyFilters);
headerCells.forEach(th => th.addEventListener('click', () => setSort(th.dataset.key)));

/* boot */
fetchCSV();
</script>
</body>
</html>
